<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Просмотр диалогов</title>
  <link rel="stylesheet" href="styles.css" />
  <style>
    .card { max-width: 980px; margin: 16px auto; padding: 16px; }
    .row { display:flex; gap:12px; flex-wrap:wrap; align-items:flex-end; }
    .row > div { flex:1; min-width:220px; }
    input { width:100%; padding:10px 12px; border-radius:10px; border:1px solid rgba(255,255,255,.14); background: rgba(255,255,255,.05); color:#fff; }
    button { padding:10px 14px; border-radius:999px; border:1px solid rgba(255,255,255,.18); background: rgba(255,255,255,.08); color:#fff; cursor:pointer; }
    button:hover { background: rgba(255,255,255,.12); }
    ul { list-style:none; padding:0; margin:12px 0 0; }
    li { padding:10px 12px; border-radius:12px; border:1px solid rgba(255,255,255,.10); background: rgba(255,255,255,.04); margin-bottom:8px; cursor:pointer; }
    li:hover { background: rgba(255,255,255,.07); }
    pre { white-space:pre-wrap; word-break:break-word; padding:12px; border-radius:12px; background: rgba(255,255,255,.04); border:1px solid rgba(255,255,255,.10); }
    .muted { opacity:.7; font-size:12px; }
  </style>
</head>
<body>
  <div class="topbar">
    <div class="topbar__left">
      <div class="logo">Просмотр диалогов</div>
      <div class="muted">Токен нужен только для просмотра</div>
    </div>
  </div>

  <div class="card">
    <div class="row">
      <div>
        <label class="muted">Worker base URL</label>
        <input id="baseUrl" value="https://d5de7bqfdbt3i3ft9ggb.qsvaa8tq.apigw.yandexcloud.net" />
      </div>
      <div>
        <label class="muted">Token (REVIEW_TOKEN)</label>
        <input id="token" value="read-chat-1357" />
      </div>
      <div style="flex:0 0 auto;">
        <button id="btnLoad">Загрузить список</button>
      </div>
    </div>

    <div class="row" style="margin-top:12px;">
      <div style="flex:1;">
        <div class="muted" style="margin:6px 0;">Список сохранений</div>
        <ul id="list"></ul>
      </div>
      <div style="flex:1; min-width:320px;">
        <div class="muted" style="margin:6px 0;">Детали</div>
        <pre id="details">Выберите элемент слева</pre>
      </div>
    </div>
  </div>

<script>
const els = {
  baseUrl: document.getElementById('baseUrl'),
  token: document.getElementById('token'),
  btnLoad: document.getElementById('btnLoad'),
  list: document.getElementById('list'),
  details: document.getElementById('details'),
};

function normBase(u) {
  return String(u||'').trim().replace(/\/+$/,'');
}

function savePrefs() {
  localStorage.setItem('review_baseUrl', els.baseUrl.value);
  localStorage.setItem('review_token', els.token.value);
}

function loadPrefs() {
  const b = localStorage.getItem('review_baseUrl');
  const t = localStorage.getItem('review_token');
  if (b) els.baseUrl.value = b;
  if (t) els.token.value = t;
}

async function api(path, opts={}) {
  const base = normBase(els.baseUrl.value);
  const token = String(els.token.value||'').trim();
  const headers = Object.assign({}, opts.headers||{});
  if (token) headers['X-Token'] = token; // IMPORTANT: backend checks X-Token or ?token=
  const res = await fetch(base + path, Object.assign({}, opts, { headers }));
  const text = await res.text();
  if (!res.ok) {
    throw new Error(`HTTP ${res.status}: ${text.slice(0,300)}`);
  }
  try { return JSON.parse(text); } catch { return text; }
}

function renderList(keys) {
  els.list.innerHTML = '';
  (keys || []).forEach(k => {
    const li = document.createElement('li');
    li.textContent = k.name || k.key || k;
    li.onclick = async () => {
      try {
        els.details.textContent = 'Загрузка...';
        const key = (k.name || k.key || k);
        const data = await api('/get?key=' + encodeURIComponent(key));
        els.details.textContent = JSON.stringify(data, null, 2);
      } catch (e) {
        els.details.textContent = String(e);
      }
    };
    els.list.appendChild(li);
  });
}

els.btnLoad.onclick = async () => {
  savePrefs();
  try {
    els.details.textContent = '';
    const keys = await api('/list');
    renderList(keys);
    if (!keys || !keys.length) {
      els.details.textContent = 'Список пуст или нет доступа.';
    }
  } catch (e) {
    alert('Forbidden/ошибка загрузки. Проверьте токен и base URL.\n\n' + e);
  }
};

loadPrefs();
</script>
</body>
</html>
