<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Просмотр диалогов</title>
  <link rel="stylesheet" href="styles.css" />
  <style>
    :root {
      --card: rgba(255,255,255,.05);
      --border: rgba(255,255,255,.12);
      --muted: rgba(255,255,255,.7);
      --bg: rgba(0,0,0,.18);

      --mgrBubble: rgba(255,255,255,.92);
      --mgrText: rgba(0,0,0,.88);
      --cliBubble: rgba(255,255,255,.08);
      --cliText: rgba(255,255,255,.92);
    }

    .wrap { max-width: 1260px; margin: 16px auto; padding: 0 12px; }
    .card { background: var(--card); border: 1px solid var(--border); border-radius: 18px; padding: 16px; }
    .row { display:flex; gap:12px; flex-wrap:wrap; align-items:flex-end; }
    .row > div { flex:1; min-width:240px; }
    input { width:100%; padding:10px 12px; border-radius:12px; border:1px solid var(--border); background: var(--bg); color:#fff; }
    button { padding:10px 14px; border-radius:999px; border:1px solid var(--border); background: rgba(255,255,255,.08); color:#fff; cursor:pointer; }
    button:hover { background: rgba(255,255,255,.12); }
    .muted { color: var(--muted); font-size:12px; }

    .grid { display:grid; grid-template-columns: 420px 1fr; gap:12px; margin-top:12px; }
    @media (max-width: 980px) { .grid { grid-template-columns: 1fr; } }

    ul { list-style:none; padding:0; margin:0; max-height: calc(100vh - 240px); overflow:auto; }
    li { padding:10px 12px; border-radius:14px; border:1px solid rgba(255,255,255,.10); background: rgba(255,255,255,.04); margin-bottom:8px; cursor:pointer; }
    li:hover { background: rgba(255,255,255,.07); }
    li .k { font-size:12px; color: var(--muted); margin-top:4px; word-break:break-all; }

    .pane { min-height: 520px; }
    .section { margin-bottom: 14px; }
    .section h3 { margin: 0 0 8px; font-size: 14px; }

    .pill { display:inline-block; padding:4px 10px; border-radius:999px; border:1px solid var(--border); background: rgba(255,255,255,.06); font-size:12px; margin: 0 6px 6px 0; }

    .chat { display:flex; flex-direction:column; gap:12px; padding: 6px 2px; }
    .chatWrap{max-height: 520px; overflow-y:auto; padding-right:6px;}
    @media (max-width: 980px){.chatWrap{max-height: 60vh;}}

    .msgRow { display:flex; }
    .msgRow.me { justify-content:flex-end; }
    .msgRow.them { justify-content:flex-start; }
    .bubble {
      max-width: 82%;
      padding:12px 14px;
      border-radius: 18px;
      border: 1px solid rgba(255,255,255,.10);
      line-height: 1.35;
      white-space: pre-wrap;
      word-break: break-word;
    }
    .bubble.me {
      background: var(--mgrBubble);
      color: var(--mgrText);
      border-color: rgba(255,255,255,.18);
    }
    .bubble.them {
      background: var(--cliBubble);
      color: var(--cliText);
    }
    .meta { font-size:11px; color: var(--muted); margin-top:6px; }

    details summary { cursor:pointer; }
    pre { white-space:pre-wrap; word-break:break-word; padding:12px; border-radius:12px; background: var(--bg); border:1px solid rgba(255,255,255,.10); }

    /* Score table */
    .scoreHeader { display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
    .scoreBig { font-size: 22px; font-weight: 700; }
    .scoreBar {
      height: 8px; border-radius: 999px; background: rgba(255,255,255,.10);
      overflow:hidden; flex: 1; min-width: 200px;
    }
    .scoreBar > div { height:100%; background: rgba(120,180,255,.55); width:0%; }
    .scoreBlock { margin-top: 10px; padding: 10px; border: 1px solid rgba(255,255,255,.10); background: rgba(255,255,255,.03); border-radius: 14px; }
    .scoreBlockTitle { font-size: 13px; margin: 0 0 8px; color: rgba(255,255,255,.92); }
    .scoreRow { display:flex; gap:10px; justify-content:space-between; align-items:flex-start; padding: 8px 10px; border-radius: 12px; }
    .scoreRow:nth-child(odd) { background: rgba(255,255,255,.02); }
    .scoreLeft { display:flex; gap:10px; align-items:flex-start; }
    .mark { width:18px; height:18px; border-radius: 6px; display:inline-flex; align-items:center; justify-content:center; border:1px solid rgba(255,255,255,.18); margin-top:2px; }
    .mark.ok { background: rgba(90,200,140,.22); }
    .mark.no { background: rgba(255,120,120,.14); }
    .scoreTitle { font-size: 13px; }
    .pts { font-size: 12px; color: var(--muted); white-space:nowrap; padding-top:2px; }
      body{background:#000;}
</style>
</head>
<body>
  <div class="topbar">
    <div class="topbar__left">
      <div class="logo">Просмотр диалогов</div>
      <div class="muted">Токен нужен только для просмотра</div>
    </div>
  </div>

  <div class="wrap">
    <div class="card">
      <div class="row">
        <div>
          <div class="muted">Worker base URL</div>
          <input id="baseUrl" value="https://d5de7bqfdbt3i3ft9ggb.qsvaa8tq.apigw.yandexcloud.net">
        </div>
        <div>
          <div class="muted">Token (REVIEW_TOKEN)</div>
          <input id="token" value="read-chat-1357">
        </div>
        <div style="flex:0 0 auto;">
          <button id="btnLoad">Загрузить список</button>
        </div>
      </div>

      <div class="grid">
        <div class="card pane" style="padding:12px;">
          <div class="section">
            <div class="muted" style="margin-bottom:8px;">Список сохранений</div>
            <div class="muted" style="margin-bottom:10px;">Подсказка: диалоги — ключи, которые начинаются с <b>s_</b>. Ключи <b>sess:</b> — это только настройки.</div>
            <ul id="list"></ul>
          </div>
        </div>

        <div class="card pane" style="padding:12px;">
          <div id="viewer" class="section">
            <div class="muted">Выберите элемент слева</div>
          </div>

          <details style="margin-top:12px;">
            <summary class="muted">Показать сырой JSON</summary>
            <pre id="raw">—</pre>
          </details>
        </div>
      </div>
    </div>
  </div>

<script>
const els = {
  baseUrl: document.getElementById('baseUrl'),
  token: document.getElementById('token'),
  btnLoad: document.getElementById('btnLoad'),
  list: document.getElementById('list'),
  viewer: document.getElementById('viewer'),
  raw: document.getElementById('raw'),
};

function normBase(u) {
  return String(u||'').trim().replace(/\/+$/,'');
}
function savePrefs() {
  localStorage.setItem('review_baseUrl', els.baseUrl.value);
  localStorage.setItem('review_token', els.token.value);
}
function loadPrefs() {
  const b = localStorage.getItem('review_baseUrl');
  const t = localStorage.getItem('review_token');
  if (b) els.baseUrl.value = b;
  if (t) els.token.value = t;
}

async function api(path, opts={}) {
  const base = normBase(els.baseUrl.value);
  const token = String(els.token.value||'').trim();
  const headers = Object.assign({}, opts.headers||{});
  if (token) headers['X-Token'] = token;
  const res = await fetch(base + path, Object.assign({}, opts, { headers }));
  const text = await res.text();
  if (!res.ok) throw new Error(`HTTP ${res.status}: ${text.slice(0,300)}`);
  try { return JSON.parse(text); } catch { return text; }
}

function escapeHtml(s) {
  return String(s||'')
    .replaceAll('&','&amp;')
    .replaceAll('<','&lt;')
    .replaceAll('>','&gt;')
    .replaceAll('"','&quot;')
    .replaceAll("'","&#039;");
}

function asText(x) {
  if (x == null) return '';
  if (typeof x === 'string') return x;
  if (typeof x === 'object') return (x.content || x.text || '');
  return String(x);
}

function detectMessages(obj) {
  const candidates = [
    obj?.transcript,
    obj?.session?.transcript,
    obj?.history,
    obj?.dialog,
    obj?.messages,
    obj?.body?.history,
    obj?.result?.history,
  ];
  for (const c of candidates) {
    if (Array.isArray(c) && c.length) return c;
  }
  return null;
}

function pickScenario(obj) {
  return obj?.scenario || obj?.session?.scenario || obj?.body?.scenario || null;
}

function pickManagerFio(obj) {
  return obj?.manager?.fio
      || obj?.session?.manager?.fio
      || obj?.scenario?.manager?.fio
      || obj?.session?.scenario?.manager?.fio
      || '';
}


function renderTitle(obj){
  const fio = pickManagerFio(obj);
  const dt = obj.createdAt || obj.endedAt || obj.metadata?.endedAt || obj.metadata?.createdAt || '';
  const dtShort = dt ? String(dt).replace('T',' ').replace('Z','') : '';
  if (fio && dtShort) return `Диалог — ${fio} — ${dtShort}`;
  if (fio) return `Диалог — ${fio}`;
  if (dtShort) return `Диалог — ${dtShort}`;
  return 'Диалог';
}

function renderScenarioPills(obj) {
  const scn = pickScenario(obj);
  const mFio = pickManagerFio(obj);
  const c = scn?.client || scn || {};

  const pills = [];
  if (mFio) pills.push(`Менеджер: ${mFio}`);
  if (c.name) pills.push(`Клиент: ${c.name}`);
  if (c.city) pills.push(`Город: ${c.city}`);
  if (c.tone) pills.push(`Тон: ${c.tone}`);
  if (c.delivery != null && c.delivery !== '') pills.push(`Доставка: ${c.delivery}`);
  if (c.goal) pills.push(`Цель: ${c.goal}`);

  return pills.map(p => `<span class="pill">${escapeHtml(p)}</span>`).join('');
}

function isManagerRole(r) {
  const role = String(r||'').toLowerCase();
  return (role === 'user' || role === 'manager');
}
function roleLabel(r) {
  return isManagerRole(r) ? 'Менеджер' : 'Клиент';
}

function renderChat(msgs) {
  const chat = document.createElement('div');
  chat.className = 'chat';

  (msgs||[]).forEach(m => {
    const role = m.role || m.author || m.from || m.sender;
    const text = asText(m);
    if (!String(text||'').trim()) return;

    const row = document.createElement('div');
    const me = isManagerRole(role);
    row.className = 'msgRow ' + (me ? 'me' : 'them');

    const b = document.createElement('div');
    b.className = 'bubble ' + (me ? 'me' : 'them');
    b.innerHTML = escapeHtml(text);

    const meta = document.createElement('div');
    meta.className = 'meta';
    meta.textContent = roleLabel(role) + (m.ts ? (' · ' + m.ts) : '');

    b.appendChild(meta);
    row.appendChild(b);
    chat.appendChild(row);
  });

  return chat;
}

function groupFlags(flagsObj) {
  // flags: { key: {ok, points, block, title} }
  const arr = [];
  for (const [k, v] of Object.entries(flagsObj||{})) {
    if (!v || typeof v !== 'object') continue;
    arr.push({ key: k, ok: !!v.ok, points: Number(v.points||0), block: v.block || 'Без блока', title: v.title || k });
  }
  arr.sort((a,b)=> (a.block||'').localeCompare(b.block||'') || (a.title||'').localeCompare(b.title||''));
  const grouped = new Map();
  for (const it of arr) {
    if (!grouped.has(it.block)) grouped.set(it.block, []);
    grouped.get(it.block).push(it);
  }
  return grouped;
}

function renderScore(obj) {
  const score = obj?.score || obj?.session?.score || null;
  const flags = obj?.flags || obj?.session?.flags || null;
  if (!score && !flags) return null;

  const sec = document.createElement('div');
  sec.className = 'section';
  sec.innerHTML = '<h3>Оценка</h3>';

  if (score && typeof score === 'object') {
    const total = Number(score.total||0);
    const max = Math.max(1, Number(score.max||0));
    const pct = Math.max(0, Math.min(100, Math.round((total/max)*100)));

    const head = document.createElement('div');
    head.className = 'scoreHeader';
    head.innerHTML = `
      <div class="scoreBig">${escapeHtml(String(total))} / ${escapeHtml(String(max))}</div>
      <div class="scoreBar"><div style="width:${pct}%"></div></div>
      <div class="muted">${pct}%</div>
    `;
    sec.appendChild(head);
  }

  if (flags && typeof flags === 'object') {
    const grouped = groupFlags(flags);
    for (const [block, items] of grouped.entries()) {
      const blk = document.createElement('div');
      blk.className = 'scoreBlock';
      blk.innerHTML = `<div class="scoreBlockTitle">${escapeHtml(block)}</div>`;
      for (const it of items) {
        const row = document.createElement('div');
        row.className = 'scoreRow';
        row.innerHTML = `
          <div class="scoreLeft">
            <div class="mark ${it.ok ? 'ok' : 'no'}">${it.ok ? '✓' : '×'}</div>
            <div class="scoreTitle">${escapeHtml(it.title)}</div>
          </div>
          <div class="pts">${it.ok ? '+' : '0'}${escapeHtml(String(it.points||0))}</div>
        `;
        blk.appendChild(row);
      }
      sec.appendChild(blk);
    }
  }

  return sec;
}

function renderViewer(obj) {
  els.viewer.innerHTML = '';
  els.raw.textContent = JSON.stringify(obj, null, 2);

  const createdAt = obj.createdAt || obj.endedAt || obj.metadata?.endedAt || obj.metadata?.createdAt || '';
  const sid = obj.sid || obj.metadata?.sid || '';

  const header = document.createElement('div');
  header.className = 'section';
  header.innerHTML = `
    <h3>${escapeHtml(renderTitle(obj))}</h3>
    <div class="muted">${escapeHtml(createdAt ? ('Дата: ' + createdAt) : '—')}${sid ? (' · sid: ' + sid) : ''}</div>
    <div style="margin-top:8px;">${renderScenarioPills(obj) || '<span class="muted">—</span>'}</div>
  `;
  els.viewer.appendChild(header);

  const msgs = detectMessages(obj);
  if (msgs) {
    const sec = document.createElement('div');
    sec.className = 'section';
    sec.innerHTML = '<h3>Диалог</h3>';
    const wrap = document.createElement('div');
    wrap.className = 'chatWrap';
    wrap.appendChild(renderChat(msgs));
    sec.appendChild(wrap);
    els.viewer.appendChild(sec);
  } else {
    const sec = document.createElement('div');
    sec.className = 'section';
    sec.innerHTML = '<h3>Данные сессии</h3><div class="muted">Это похоже на настройки (без переписки) или формат не распознан. Сырой JSON ниже.</div>';
    els.viewer.appendChild(sec);
  }

  const scoreSec = renderScore(obj);
  if (scoreSec) els.viewer.appendChild(scoreSec);
}


// --- list enrichment: add manager fio + date without clicking ---
function pLimit(limit){
  let active = 0;
  const queue = [];
  const next = () => {
    if (active >= limit || queue.length === 0) return;
    active++;
    const {fn, resolve, reject} = queue.shift();
    Promise.resolve()
      .then(fn)
      .then(resolve, reject)
      .finally(() => { active--; next(); });
  };
  return (fn) => new Promise((resolve, reject) => { queue.push({fn, resolve, reject}); next(); });
}

async function enrichListItem(key, li){
  try{
    const isSess = String(key).startsWith('sess:');
    if (isSess) return;
    const data = await api('/get?key=' + encodeURIComponent(key));
    const fio = pickManagerFio(data) || '—';
    const dt = data.createdAt || data.endedAt || data.metadata?.endedAt || data.metadata?.createdAt || '';
    const dtShort = dt ? String(dt).slice(0,19).replace('T',' ') : '—';
    const sub = li.querySelector('.k');
    if (sub) sub.textContent = `Диалог/результат (s_...) · ${fio} · ${dtShort}`;
  } catch(e){
    // silently ignore (token, network, etc.)
  }
}
function renderList(keys) {
  els.list.innerHTML = '';
  (keys || []).forEach(k => {
    const key = (k.name || k.key || k);
    const li = document.createElement('li');
    const isSess = String(key).startsWith('sess:');
    li.innerHTML = `
      <div>${escapeHtml(key)}</div>
      <div class="k">${isSess ? 'Настройки (sess:...)' : 'Диалог/результат (s_...)'}</div>
    `;
    li.onclick = async () => {
      try {
        els.viewer.innerHTML = '<div class="muted">Загрузка…</div>';
        const data = await api('/get?key=' + encodeURIComponent(key));
        renderViewer(data);
        try {
          const fio = pickManagerFio(data);
          const dt = data.createdAt || data.endedAt || data.metadata?.endedAt || data.metadata?.createdAt || '';
          const dtShort = dt ? String(dt).slice(0,19).replace('T',' ') : '';
          const sub = li.querySelector('.k');
          if (sub) sub.textContent = (String(key).startsWith('sess:') ? 'Настройки (sess:...)' : 'Диалог/результат (s_...)') + (fio || dtShort ? ` · ${fio || '—'} · ${dtShort || '—'}` : '');
        } catch(e) {}

      } catch (e) {
        els.viewer.innerHTML = '<pre>' + escapeHtml(String(e)) + '</pre>';
      }
    };
    els.list.appendChild(li);
    // enrich subtitle (manager fio + date) in background
    if (!String(key).startsWith('sess:')) {
      if (!window.__enrichLimit) window.__enrichLimit = pLimit(6);
      window.__enrichLimit(() => enrichListItem(key, li));
    }
  });
}

els.btnLoad.onclick = async () => {
  savePrefs();
  try {
    els.viewer.innerHTML = '';
    const keys = await api('/list');
    renderList(keys);
    if (!keys || !keys.length) {
      els.viewer.innerHTML = '<div class="muted">Список пуст или нет доступа.</div>';
    }
  } catch (e) {
    alert('Ошибка загрузки. Проверьте token и base URL.\n\n' + e);
  }
};

loadPrefs();
</script>
</body>
</html>